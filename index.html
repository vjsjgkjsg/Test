<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>NeoBank</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
  margin: 0;
  height: 100vh;
  background: radial-gradient(circle at top, #1a1f2b, #0b0f18);
  display: flex;
  justify-content: center;
  align-items: center;
  font-family: system-ui;
  color: #fff;
}
.card {
  width: 340px;
  padding: 30px;
  border-radius: 20px;
  background: rgba(255,255,255,0.06);
  backdrop-filter: blur(20px);
  text-align: center;
}
button {
  width: 100%;
  padding: 14px;
  border-radius: 14px;
  border: none;
  margin-top: 12px;
  font-size: 16px;
  cursor: pointer;
}
.primary {
  background: linear-gradient(135deg,#4cff91,#00c6ff);
  color: #000;
  font-weight: 600;
}
.secondary {
  background: rgba(255,255,255,0.12);
  color: #fff;
}
.pin {
  display: flex;
  justify-content: space-between;
  margin: 20px 0;
}
.dot {
  width: 14px;
  height: 14px;
  border-radius: 50%;
  border: 2px solid rgba(255,255,255,0.4);
}
.dot.filled {
  background: #4cff91;
  border-color: #4cff91;
}
.keypad {
  display: grid;
  grid-template-columns: repeat(3,1fr);
  gap: 10px;
}
.keypad button {
  height: 55px;
  border-radius: 14px;
  background: rgba(255,255,255,0.1);
  color: #fff;
  font-size: 18px;
}
</style>
</head>
<body>

<div class="card" id="app"></div>

<script>
const app = document.getElementById("app");
let pin = "";

const hasPin = () => localStorage.getItem("pinHash");
const hasBio = () => localStorage.getItem("biometric");

async function sha(text) {
  const enc = new TextEncoder().encode(text);
  const buf = await crypto.subtle.digest("SHA-256", enc);
  return [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,"0")).join("");
}

/* ---------- BIOMETRIC ---------- */
async function registerBiometric() {
  const publicKey = {
    challenge: crypto.getRandomValues(new Uint8Array(32)),
    rp: { name: "NeoBank" },
    user: {
      id: crypto.getRandomValues(new Uint8Array(16)),
      name: "user",
      displayName: "NeoBank User"
    },
    pubKeyCredParams: [{ type: "public-key", alg: -7 }],
    authenticatorSelection: {
      authenticatorAttachment: "platform",
      userVerification: "required"
    }
  };
  await navigator.credentials.create({ publicKey });
  localStorage.setItem("biometric", "1");
}

async function biometricLogin() {
  await navigator.credentials.get({
    publicKey: {
      challenge: crypto.getRandomValues(new Uint8Array(32)),
      userVerification: "required"
    }
  });
  dashboard();
}

/* ---------- PIN UI ---------- */
function pinUI(onDone) {
  pin = "";
  app.innerHTML = `
    <h2>–í–≤–µ–¥–∏—Ç–µ PIN</h2>
    <div class="pin">${"<div class='dot'></div>".repeat(4)}</div>
    <div class="keypad">
      ${[1,2,3,4,5,6,7,8,9,"‚å´",0,"C"].map(x=>`<button>${x}</button>`).join("")}
    </div>
  `;
  const dots = document.querySelectorAll(".dot");
  document.querySelectorAll(".keypad button").forEach(b=>{
    b.onclick = async ()=>{
      if (b.textContent==="‚å´") pin=pin.slice(0,-1);
      else if (b.textContent==="C") pin="";
      else if (pin.length<4) pin+=b.textContent;

      dots.forEach((d,i)=>d.classList.toggle("filled",i<pin.length));

      if (pin.length===4) onDone(pin);
    };
  });
}

/* ---------- FLOWS ---------- */
async function firstRun() {
  app.innerHTML = `
    <h2>–°–æ–∑–¥–∞–π—Ç–µ –æ—Ç–ø–µ—á–∞—Ç–æ–∫</h2>
    <button class="primary">–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –ø–∞–ª–µ—Ü</button>
  `;
  app.querySelector("button").onclick = async ()=>{
    await registerBiometric();
    pinUI(async p=>{
      localStorage.setItem("pinHash", await sha(p));
      dashboard();
    });
  };
}

function login() {
  app.innerHTML = `
    <h2>–í—Ö–æ–¥</h2>
    <button class="primary">üëÜ –í–æ–π—Ç–∏ –ø–æ –æ—Ç–ø–µ—á–∞—Ç–∫—É</button>
    <button class="secondary">–í–æ–π—Ç–∏ –ø–æ PIN</button>
  `;
  app.querySelector(".primary").onclick = async ()=>{
    try { await biometricLogin(); } catch {}
  };
  app.querySelector(".secondary").onclick = ()=>{
    pinUI(async p=>{
      if (await sha(p) === localStorage.getItem("pinHash")) dashboard();
      else alert("–ù–µ–≤–µ—Ä–Ω—ã–π PIN");
    });
  };
}

function dashboard() {
  app.innerHTML = `
    <h2>üè¶ –¢–µ—Å—Ç–æ–≤—ã–π –±–∞–Ω–∫</h2>
    <p>–í—ã —É—Å–ø–µ—à–Ω–æ –≤–æ—à–ª–∏</p>
    <button class="secondary">–í—ã–π—Ç–∏</button>
  `;
  app.querySelector("button").onclick = login;
}

/* ---------- START ---------- */
if (!hasBio() || !hasPin()) firstRun();
else login();
</script>

</body>
</html>
